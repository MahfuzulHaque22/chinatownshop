<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bKash Payment</title>
    <link href="https://fonts.googleapis.com/css2?family=Jost&display=swap" rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        :root {
            --bkash-primary: #E2136E;
            --text-dark: #222;
            --text-light: #fff;
        }

        body {
            margin: 0;
            font-family: "Jost", sans-serif;
            background: #f8f8f8;
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--bkash-primary);
            padding: 12px;
            display: flex;
            align-items: center;
            color: white;
        }

        header img {
            height: 35px;
            width: 90px;
            padding-left: 20px;
        }

        /* Payment Container */
        .payment-container {
            flex: 1;
            max-width: 500px;
            margin: 20px auto;
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .payment-header {
            text-align: center;
        }

        .payment-header img {
            height: 50px;
            margin-bottom: 12px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .verify-section {
            margin: 15px 0;
        }

        .verify-section input[type="text"],
        .txid-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 8px;
            box-sizing: border-box;
            /* ✅ add this */
        }


        .qr-section {
            margin: 20px 0;
            text-align: center;
        }

        .qr-section img {
            width: 180px;
            height: 180px;
            object-fit: contain;
            margin-bottom: 12px;
        }

        .merchant-number {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .merchant-number button {
            background: var(--bkash-primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .terms {
            margin: 15px 0;
        }

        .instructions {
            font-size: 0.9rem;
            color: #444;
            margin-bottom: 10px;
        }

        .txid-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 6px;
        }

        .confirm-btn {
            display: block;
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background: var(--bkash-primary);
            border: none;
            color: white;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Popup */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .popup-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }

        .popup-content button {
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--bkash-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .user-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .merchant-number {
                flex-direction: column;
                gap: 6px;
            }
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header>
        <img src="assets/images/bkash.png" alt="bKash Logo">
    </header>

    <!-- Payment Content -->
    <div class="payment-container">

        <!-- Payment Header -->
        <div class="payment-header">
            <img src="assets/images/bkash_payment_logo.png" alt="bKash Logo">
        </div>

        <!-- User Info -->
        <div class="user-info">
            <div>
                <span id="userName">Loading...</span><br>
                <span id="userNumber">Loading...</span>
            </div>
            <div>Total: <span id="totalAmount">৳0</span></div>
        </div>

        <!-- Verify Section -->
        <div class="verify-section">
            <label><input type="checkbox" id="useSavedNumber"> Use saved number</label>
            <input type="text" id="bkashNumber" placeholder="Enter your bKash number">
        </div>

        <!-- QR Section -->
        <div class="qr-section">
            <img src="assets/images/qr.png" alt="QR Code">
            <div class="merchant-number">
                <span id="merchantNumber">+8801707423938</span>
                <button onclick="copyMerchantNumber()">Copy</button>
            </div>
        </div>

        <!-- Terms -->
        <div class="terms">
            <label><input type="checkbox" id="agreeTerms"> I agree to the Terms and Conditions</label>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            Please scan this QR code to make payment or use the number to make payment.<br>
            After payment, copy your TxID and enter it below.
        </div>

        <!-- TxID Input -->
        <div class="txid-section">
            <label for="txid">Enter TxID:</label>
            <input type="text" id="txid" placeholder="Enter your TxID">
        </div>

        <!-- Confirm Button -->
        <button class="confirm-btn" onclick="confirmPayment()">Confirm</button>
    </div>

    <!-- Popup -->
    <div class="popup" id="popup">
        <div class="popup-content">
            <h3>Thank You!</h3>
            <p>We will proceed with your request and verify your order in 12 to 24 hours.</p>
            <button onclick="closePopup()">OK</button>
        </div>
    </div>

    <!-- Firebase + Script -->
    <script type="module">
        import { db, auth } from "./firebase-init.js";
        import {
            doc,
            getDoc,
            setDoc,
            updateDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

        const userNameEl = document.getElementById("userName");
        const userNumberEl = document.getElementById("userNumber");
        const bkashNumber = document.getElementById("bkashNumber");
        const useSavedNumber = document.getElementById("useSavedNumber");
        const totalAmountEl = document.getElementById("totalAmount");

        // Load pending order
        const pendingOrder = JSON.parse(localStorage.getItem("pendingOrder") || "{}");
        if (!pendingOrder.total) {
            window.location.href = "cart.html";
        } else {
            totalAmountEl.textContent = "৳" + pendingOrder.total;
        }

        // Load user info
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                alert("Please login first!");
                window.location.href = "login.html";
                return;
            }

            userNameEl.textContent = user.displayName || "Unknown User";

            // Try Auth phone number first
            let phone = user.phoneNumber;

            // Fetch from Firestore if Auth phone is not present
            try {
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                if (snap.exists() && snap.data().phone) {
                    phone = snap.data().phone;
                }
            } catch (err) {
                console.error("Error fetching user profile:", err);
            }

            if (phone) {
                userNumberEl.textContent = phone;
                userNumberEl.dataset.hasPhone = "true";
            } else {
                userNumberEl.textContent = "No number saved";
                userNumberEl.dataset.hasPhone = "false";
            }
        });

        // Use saved number toggle
        useSavedNumber.addEventListener("change", () => {
            const savedNumber = userNumberEl.textContent;
            const hasPhone = userNumberEl.dataset.hasPhone === "true";

            if (useSavedNumber.checked) {
                if (hasPhone && savedNumber) {
                    bkashNumber.value = savedNumber;
                    bkashNumber.readOnly = true;
                } else {
                    alert("No saved number found!");
                    useSavedNumber.checked = false;
                }
            } else {
                bkashNumber.value = "";
                bkashNumber.readOnly = false;
            }
        });

        // Copy merchant number
        window.copyMerchantNumber = () => {
            const num = document.getElementById("merchantNumber").textContent;
            navigator.clipboard.writeText(num);
            alert("Merchant number copied!");
        };

        // --- Generate human-friendly unique order ID (async, checks collisions) ---
        async function generateOrderId(prefix = "ORD") {
            const now = new Date();
            const datePart = now.getFullYear().toString().slice(2) +
                (now.getMonth() + 1).toString().padStart(2, "0") +
                now.getDate().toString().padStart(2, "0");

            // Try a few random candidates and ensure no existing document with the same ID
            for (let i = 0; i < 6; i++) {
                const randomPart = Math.random().toString(36).slice(2, 6).toUpperCase(); // 4 chars
                const candidate = `${prefix}-${datePart}-${randomPart}`;
                try {
                    const snap = await getDoc(doc(db, "orders", candidate));
                    if (!snap.exists()) return candidate;
                } catch (e) {
                    console.warn("Error checking orderId existence:", e);
                    // fallthrough to next iteration (still try other candidates)
                }
            }

            // Fallback: use timestamp if unlucky
            return `${prefix}-${datePart}-${Date.now().toString(36).toUpperCase()}`;
        }

        // Confirm payment
        window.confirmPayment = async () => {
            const txid = document.getElementById("txid").value.trim();
            const number = bkashNumber.value.trim();
            const agree = document.getElementById("agreeTerms").checked;

            if (!agree) return alert("You must agree to the terms!");
            if (!txid || !number) return alert("Please enter all details!");

            const user = auth.currentUser;
            if (!user) return alert("Please login first!");

            try {
                const orderId = await generateOrderId(); // <-- await the async generator
                const orderRef = doc(db, "orders", orderId);

                // Step 1: create order with placeholder timestamp in timeline (serverTimestamp can't be inside arrays on initial set)
                await setDoc(orderRef, {
                    orderId,
                    uid: user.uid,
                    name: user.displayName || "Unknown",
                    number,
                    amount: Number(pendingOrder.total) || 0,
                    txid,
                    items: pendingOrder.items || [],
                    status: "order_placed_payment_in_review",
                    statusTimeline: [
                        {
                            status: "order_placed_payment_in_review",
                            time: null, // placeholder
                            by: "user"
                        }
                    ],
                    createdAt: serverTimestamp()
                });

                // Step 2: set the actual serverTimestamp into the array element
                await updateDoc(orderRef, {
                    "statusTimeline.0.time": serverTimestamp()
                });

                // Save bKash number to user's Firestore profile (attempt update, fallback to set with merge)
                try {
                    const userRef = doc(db, "users", user.uid);
                    await updateDoc(userRef, { phone: number });
                } catch (err) {
                    // If update fails (doc missing), create/merge the user doc
                    try {
                        await setDoc(doc(db, "users", user.uid), { phone: number }, { merge: true });
                    } catch (e) {
                        console.warn("Couldn't write phone to user profile:", e);
                    }
                }

                console.log("Order placed successfully ✅", orderId);

                // Clear localStorage (order + checkout)
                localStorage.removeItem("pendingOrder");
                localStorage.removeItem("checkoutItems");

                // Remove purchased items from cart (preserve others)
                let cart = JSON.parse(localStorage.getItem("cart") || "[]");
                const purchased = pendingOrder.items || [];
                cart = cart.filter(f => {
                    return !purchased.some(p =>
                        p.id === f.id &&
                        JSON.stringify(p.selectedVariants || {}) === JSON.stringify(f.selectedVariants || {})
                    );
                });
                localStorage.setItem("cart", JSON.stringify(cart));

                // Show popup
                document.getElementById("popup").style.display = "flex";
            } catch (err) {
                console.error("Error saving order or phone number:", err);
                alert("Error saving order: " + (err.message || err));
            }
        };

        // Close popup
        window.closePopup = () => {
            document.getElementById("popup").style.display = "none";
            window.location.href = "products.html";
        };
    </script>


</body>

</html>